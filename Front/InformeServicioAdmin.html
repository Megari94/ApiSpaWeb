<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Informe de Servicios</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="css/estilo.css">
    <script src="js/script.js" defer></script>
    <script src="js/scriptAdmin.js" defer></script>
    <style>
   

       
    </style>
</head>
<body>
    <div class="container">
        <!-- Barra de Menú Lateral -->
        <div id="sidebar" class="sidebar">
            <div class="link-container">
                 <a href="#" id="clienteAdminLink"><i class="fas fa-users"></i>Clientes</a>
                <a href="#" id="PersonalLink"><i class="fas fa-user-tie"></i>Personal</a>
                <a href="#" id="TurnoLink"><i class="fas fa-calendar-alt"></i>Turno</a>
                <a href="#" id="ServicioLink"><i class="fas fa-concierge-bell"></i>Servicio</a>
                <a href="#"  id="IPAdminLink"><i class="fas fa-wallet"></i>Informe de Pagos</a>
                <a href="#" id="ISAdminLink"><i class="fas fa-file-alt"></i>Informe de Servicios</a>
                <a href="#" id="turnoAdminLink"><i class="fas fa-chart-pie"></i>Turnos Solicitados</a>
                <a href="#" id="facturaAdminLink"><i class="fas fa-receipt"></i>Factura</a>
            </div>
            <button class="logout-btn" id="logoutBtn" onclick="redirectToLogin()">Salir</button>
        </div>

        <!-- Contenido Principal -->
        <div class="main-content">
            <button id="menuButton" class="open-btn" onclick="toggleMenu()">☰ Menú</button>
        
            <!-- Formulario para ingresar el rango de fechas -->
            <div class="date-range-form">
                <h3>Informe de Servicios Realizados</h3>
                <label for="apellidoPersonal">Nombre del Personal:</label>
                <select id="apellidoPersonal">
                <option value="">Seleccione un personal</option> <!-- Opción por defecto -->
                </select>

                <label for="fechaInicio">Fecha de Inicio:</label>
                <input type="date" id="startDate">
                <label for="fechaFin">Fecha de Fin:</label>
                <input type="date" id="endDate">
                <div class="button-container">
                    <button onclick="generarInforme()" id="generateInvoice">Generar Informe</button>
                    <button onclick="descargarInforme()" id="downloadButton">Descargar Informe</button>
                </div>
            </div>
            
         
        </div>
    </div>
    

  <script>
    let pdfBlob; // Variable global para almacenar el Blob del PDF

    async function generarInforme() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'pt', 'a4');

        // Obtener el ID del personal seleccionado y las fechas
        const personalId = document.getElementById('apellidoPersonal').value;
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        if (!personalId || !startDate || !endDate) {
            alert("Por favor, selecciona un personal y un rango de fechas válido.");
            return;
        }

        try {
            // Obtener información del personal
            const personalResponse = await fetch(`https://spaadministrativo-production-4488.up.railway.app/Personal/personalInfo/${personalId}`);
            if (!personalResponse.ok) throw new Error("Error al obtener información del personal");
            const personal = await personalResponse.json();

            // Obtener las sesiones del personal entre las fechas
            const sesionesResponse = await fetch(`https://spaadministrativo-production-4488.up.railway.app/Sesion/sesionesAdminDTO?personalId=${personalId}&startDate=${startDate}&endDate=${endDate}`);
            if (!sesionesResponse.ok) throw new Error("Error al obtener sesiones");
            const sesiones = await sesionesResponse.json();

            // Título y encabezado del informe
            doc.setFontSize(14);
            doc.setFont("Helvetica", "bold");
            doc.text("SERVICIOS PRESTADOS", 70, 75);
            doc.setFontSize(12);
            doc.setFont("Helvetica", "normal");

            // Bordes para la estructura del informe
            doc.rect(30, 30, 550, 750); // Borde general
            doc.rect(30, 30, 550, 120); // Borde encabezado
            doc.rect(30, 660, 550, 50); // Borde subtotal y total

            // Información general del personal
            doc.setFontSize(12);
            doc.setFont("Helvetica", "normal");
            doc.text(`Nombre del Personal: ${personal.nombre} ${personal.apellido}`, 40, 170);
            doc.text(`DNI: ${personal.dni}`, 350, 170);
            doc.text(`Domicilio: ${personal.domicilio}`, 40, 190);
            doc.text(`Localidad: ${personal.localidad}`, 40, 210);
            doc.text(`Provincia: ${personal.provincia}`, 350, 210);

            // Encabezado de la tabla
            doc.setFontSize(10);
            doc.setFont("Helvetica", "bold");
            doc.text("Código", 50, 300);
            doc.text("Descripción del Servicio", 160, 300);
            doc.text("Costo", 550, 300, { align: "right" });

            // Dibujar una línea para el encabezado
            doc.line(30, 305, 580, 305);

            // Datos dinámicos de las sesiones obtenidas del backend
            let yPosition = 320;
            sesiones.forEach(sesion => {
                doc.setFont("Helvetica", "normal");
                doc.text(sesion.codigo, 50, yPosition);

                const descripcionDividida = doc.splitTextToSize(sesion.descripcion, 180);
                doc.text(descripcionDividida, 160, yPosition);

                doc.text(sesion.costo.toFixed(2), 550, yPosition, { align: "right" });

                yPosition += 20; // Ajuste para la próxima fila
                doc.line(30, yPosition + 5, 580, yPosition + 5); // Línea debajo de cada fila
            });

            // Total
            const total = sesiones.reduce((acc, sesion) => acc + sesion.costo, 0);
            doc.setFontSize(12);
            doc.setFont("Helvetica", "bold");
            doc.text(`Total: $${total.toFixed(2)}`, 400, 680);

            // Convertir PDF a Blob para vista previa
            pdfBlob = doc.output('blob');
            const pdfUrl = URL.createObjectURL(pdfBlob);

            // Mostrar vista previa
            document.getElementById('pdfPreview').src = pdfUrl;
            document.getElementById('previewContainer').style.display = 'block';

        } catch (error) {
            console.error("Error al generar el informe:", error.message);
            alert("Hubo un problema al generar el informe.");
        }
    }

    async function descargarInforme() {
        if (!pdfBlob) {
            alert("Por favor, genera el informe primero.");
            return;
        }

        // Descargar el PDF generado
        const link = document.createElement('a');
        link.href = URL.createObjectURL(pdfBlob);
        link.download = "informe_servicios.pdf";
        link.click();
    }
</script>

</body>
</html>
