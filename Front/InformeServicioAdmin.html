<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Informe de Servicios</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="css/estilo.css">
    <script src="js/script.js" defer></script>
    <script src="js/scriptAdmin.js" defer></script>
    <style>
   

       
    </style>
</head>
<body>
    <div class="container">
        <!-- Barra de Menú Lateral -->
        <div id="sidebar" class="sidebar">
            <div class="link-container">
                 <a href="#" id="clienteAdminLink"><i class="fas fa-users"></i>Clientes</a>
                <a href="#" id="PersonalLink"><i class="fas fa-user-tie"></i>Personal</a>
                <a href="#" id="TurnoLink"><i class="fas fa-calendar-alt"></i>Turno</a>
                <a href="#" id="ServicioLink"><i class="fas fa-concierge-bell"></i>Servicio</a>
                <a href="#"  id="IPAdminLink"><i class="fas fa-wallet"></i>Informe de Pagos</a>
                <a href="#" id="ISAdminLink"><i class="fas fa-file-alt"></i>Informe de Servicios</a>
                <a href="#" id="turnoAdminLink"><i class="fas fa-chart-pie"></i>Turnos Solicitados</a>
                <a href="#" id="facturaAdminLink"><i class="fas fa-receipt"></i>Factura</a>
            </div>
            <button class="logout-btn" id="logoutBtn" onclick="redirectToLogin()">Salir</button>
        </div>

        <!-- Contenido Principal -->
        <div class="main-content">
            <button id="menuButton" class="open-btn" onclick="toggleMenu()">☰ Menú</button>
        
            <!-- Formulario para ingresar el rango de fechas -->
            <div class="date-range-form">
                <h3>Informe de Servicios Realizados</h3>
                <label for="apellidoPersonal">Nombre del Personal:</label>
                <select id="apellidoPersonal">
                <option value="">Seleccione un personal</option> <!-- Opción por defecto -->
                </select>

                <label for="fechaInicio">Fecha de Inicio:</label>
                <input type="date" id="startDate">
                <label for="fechaFin">Fecha de Fin:</label>
                <input type="date" id="endDate">
                <div class="button-container">
                    <button onclick="generarInforme()" id="generateInvoice">Generar Informe</button>
                    <button onclick="descargarInforme()" id="downloadButton">Descargar Informe</button>
                </div>
            </div>
            
         
        </div>
    </div>
    

 <script>
    let pdfBlob; // Variable global para almacenar el Blob del PDF
    let personalSeleccionado = null; // Variable para almacenar los datos del personal seleccionado

    async function generarInforme() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'pt', 'a4');
        
        // Verificar si se ha seleccionado un personal
        const personalId = document.getElementById("apellidoPersonal").value;
        if (!personalId) {
            alert("Por favor, seleccione un personal.");
            return;
        }

        // Definir las fechas de inicio y fin para la consulta (puedes ajustarlas según tus necesidades)
        const startDate = new Date(); // Por ejemplo, fecha de inicio
        const endDate = new Date(); // Por ejemplo, fecha de fin
        endDate.setDate(endDate.getDate() + 1); // Un día después de la fecha de inicio

        // Obtener los detalles del personal seleccionado desde la API
        await fetch(`https://spaadministrativo-production-4488.up.railway.app/Personal/personalInfo/${personalId}`)
            .then(response => response.json())
            .then(data => {
                personalSeleccionado = data; // Guardar los datos del personal
            })
            .catch(error => {
                console.error("Error al obtener los detalles del personal:", error);
                alert("No se puede obtener los detalles del personal en este momento.");
                return;
            });

        // Título y encabezado del informe
        doc.setFontSize(14);
        doc.setFont("Helvetica", "bold");
        doc.text("SERVICIOS PRESTADOS", 70, 75);
        doc.setFontSize(12);
        doc.setFont("Helvetica", "normal");
    
        // Bordes para la estructura del informe
        doc.rect(30, 30, 550, 750); // Borde general
        doc.rect(30, 30, 550, 120); // Borde encabezado
        doc.rect(30, 660, 550, 50); // Borde subtotal y total
    
        // Detalles del informe
        doc.setFontSize(16);
        doc.setFont("Helvetica", "bold");
        doc.text("Detalle del Informe", 380, 65);
    
        // Fecha actual
        const fechaActual = new Date();
        const dia = fechaActual.getDate().toString().padStart(2, '0');
        const mes = (fechaActual.getMonth() + 1).toString().padStart(2, '0');
        const anio = fechaActual.getFullYear();
        const fechaFormateada = dia + '/' + mes + '/' + anio;
        doc.setFontSize(12);
        doc.setFont("Helvetica", "normal");
        doc.text("Fecha de Emisión: " + fechaFormateada, 380, 80);
    
        // Información general del servicio (datos del personal)
        doc.text(`Nombre del Personal: ${personalSeleccionado.nombre} ${personalSeleccionado.apellido}`, 40, 170);
        doc.text(`Nombre de Usuario: ${personalSeleccionado.nombre_usuario}`, 40, 190);
        doc.text(`Correo: ${personalSeleccionado.correo}`, 40, 210);
    
        // Encabezado de la tabla
        doc.setFontSize(10);
        doc.setFont("Helvetica", "bold");
        doc.text("Código", 50, 300);
        doc.text("Descripción del Servicio", 160, 300);
        doc.text("Costo", 550, 300, { align: "right" });
    
        // Dibujar una línea para el encabezado
        doc.line(30, 305, 580, 305);
    
        // Obtener las sesiones del personal usando el nuevo endpoint
        const sesiones = await fetch(`https://spaadministrativo-production-4488.up.railway.app/personalInfoServicios?personalId=${personalId}&startDate=${startDate.toISOString()}&endDate=${endDate.toISOString()}`)
            .then(response => response.json())
            .catch(error => {
                console.error("Error al obtener las sesiones del personal:", error);
                alert("No se puede obtener las sesiones del personal en este momento.");
                return [];
            });
    
        // Mostrar las sesiones en el PDF
        let yPosition = 320;
        sesiones.forEach(sesion => {
            doc.setFont("Helvetica", "normal");
            doc.text(sesion.codigo.toString(), 50, yPosition); // Ejemplo: código de la sesión
            doc.text(doc.splitTextToSize(sesion.descripcion, 180), 160, yPosition); // Ejemplo: descripción de la sesión
            doc.text(sesion.costo.toFixed(2), 550, yPosition, { align: "right" }); // Ejemplo: costo de la sesión
        
            yPosition += 20; // Ajuste para la próxima fila
            doc.line(30, yPosition + 5, 580, yPosition + 5); // Línea debajo de cada fila
        });
    
        // Total (ejemplo de cálculo sumando los costos de las sesiones)
        const total = sesiones.reduce((acc, sesion) => acc + sesion.costo, 0);
        doc.setFontSize(12);
        doc.setFont("Helvetica", "bold");
        doc.text(`Total: $${total.toFixed(2)}`, 400, 680);
    
        // Convertir PDF a Blob para vista previa
        pdfBlob = doc.output('blob');
        const pdfUrl = URL.createObjectURL(pdfBlob);
    
        // Mostrar vista previa (si tienes un iframe o contenedor para el PDF)
        document.getElementById('pdfPreview').src = pdfUrl;
        document.getElementById('previewContainer').style.display = 'block';
    }
    
    async function descargarInforme() {
        if (!pdfBlob) {
            alert("Por favor, genera el informe primero.");
            return;
        }
    
        // Descargar el PDF generado
        const link = document.createElement('a');
        link.href = URL.createObjectURL(pdfBlob);
        link.download = "informe_servicios.pdf";
        link.click();
    }
</script>
  <script>
    document.addEventListener("DOMContentLoaded", function() {
        cargarPersonal(); // Llama a la función para cargar el personal al cargar la página
    });

    function cargarPersonal() {
        return fetch("https://spaadministrativo-production-4488.up.railway.app/Personal/PersonalDTO")
            .then(response => {
                if (!response.ok) {
                    throw new Error("Error al obtener el personal: " + response.statusText);
                }
                return response.json();
            })
            .then(personal => {
                const selectPersonal = document.getElementById("apellidoPersonal");

                // Limpiar las opciones existentes
                selectPersonal.innerHTML = "<option value=''>Seleccione un personal</option>";

                // Crear opciones y agregarlas al select
                personal.forEach(p => {
                    const option = document.createElement("option");
                    option.value = p.id; // El valor será el ID del personal
                    option.text = p.nombre_Completo; // El texto será el nombre completo
                    selectPersonal.appendChild(option);
                });
            })
            .catch(error => {
                console.error("Error al cargar el personal:", error.message);
                alert("No se puede cargar el personal en este momento.");
            });
    }
</script>

</body>
</html>
